---
# tasks file for ovirt_snapshots_report
- name: Get snapshots info (created by Ansible)
  ovirt.ovirt.ovirt_snapshot_info:
    auth: "{{ ovirt_auth }}"
    vm: "{{ item }}"
    description: "*_by_Ansible"
  register: result
  loop: "{{ virtual_machine }}"

- name: Output snapshot info
  ansible.builtin.debug:
    msg:
      - "{{ result | json_query(query) }}"
      #- "{{ result }}"
  when: debug
  vars:
    query: "results[*].[{vm: item}, ovirt_snapshots[*] | [?snapshot_type == 'regular'].{id:id, date: date, description: description}]"

- name: Output snapshot info to CSV
  blockinfile:
    path: "{{ report.directory }}"
    marker: "# {mark}: {{ inventory_hostname }} - GENERATED BY ANSIBLE"
    block: |
      vm name,environment,location,snapshot description,create datetime,snapshot memory,snapshot type
      {% for i in result.results -%}
      {{ i.item }},{{ env }},{{ application }},{{ i.ovirt_snapshots[0].description | default("") }},{{ i.ovirt_snapshots[0].date | default("") }},{{ i.ovirt_snapshots[0].persist_memorystate | default("") }},{{ i.ovirt_snapshots[0].snapshot_type | default("") }}
      {%- if not loop.last %}

      {% else %}{%- endif %}{% endfor %}
    create: yes
  throttle: 1
