---
# tasks file for ovirt_snapshots_report_list_all
- name: Get snapshots info 
  ovirt.ovirt.ovirt_snapshot_info:
    auth: "{{ ovirt_auth }}"
    vm: "{{ item }}"
    #description: "*_by_Ansible"
  register: result
  loop: "{{ virtual_machine }}"

- name: Output snapshot info
  ansible.builtin.debug:
    msg:
      - "{{ result | json_query(query) }}"
      - "{{ result }}"
  when: debug
  vars:
    query: "results[*].[{vm: item}, ovirt_snapshots[*] | [?snapshot_type == 'regular'].{id:id, date: date, description: description}]"

- name: Output snapshot info to CSV
  blockinfile:
    path: "{{ report.directory }}"
    marker: "# {mark}: {{ inventory_hostname }} - GENERATED BY ANSIBLE"
    block: |
      vm name,environment,location,snapshot description,create datetime,snapshot memory,snapshot type
      {% for i in result.results -%}
      {% for snapshot in i.ovirt_snapshots -%}
      {{ i.item }},{{ env }},{{ application }},{{ snapshot.description | default("") }},{{ snapshot.date | default("") }},{{ snapshot.persist_memorystate | default("") }},{{ snapshot.snapshot_type | default("") }}
      {% endfor %}
      {% endfor %}
    create: yes
  throttle: 1
